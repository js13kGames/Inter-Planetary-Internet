<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
  </head>
  <body>
    <canvas id="game-canvas"></canvas>
    <script type="module">
      import init, { Universe } from "./pkg/ipi_game.js";

      let universe;
      const canvas = document.getElementById("game-canvas");
      const ctx = canvas.getContext("2d");
      let colors = ["#ff0000", "#00ff00", "#0000ff", "#000000"];

      function fill_color(i) {
        ctx.fillStyle = colors[i];
      }

      function stroke_color(i) {
        ctx.strokeStyle = colors[i];
      }

      function draw_circle(x, y, r) {
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2, true);
        ctx.fill();
      }

      function draw() {
        window.requestAnimationFrame(draw);
        universe.tick();
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        ctx.font = "30px Arial";
        ctx.strokeText("Score: " + universe.score(), 10, 40);
        // Highlight source and destination planet
        fill_color(2);
        const src_planet = universe.source_planet();
        draw_circle(
          universe.planet_x(src_planet),
          universe.planet_y(src_planet),
          universe.planet_radius(src_planet) * 1.8
        );
        fill_color(1);
        const dest_planet = universe.destination_planet();
        draw_circle(
          universe.planet_x(dest_planet),
          universe.planet_y(dest_planet),
          universe.planet_radius(dest_planet) * 1.8
        );
        // Draw packet
        if (universe.packet_bound()) {
          const planet = universe.packet_planet();
          fill_color(0);
          draw_circle(
            universe.planet_x(planet),
            universe.planet_y(planet),
            universe.planet_radius(planet) * 1.5
          );
          stroke_color(0);
          ctx.beginPath();
          ctx.moveTo(universe.planet_x(planet), universe.planet_y(planet));
          ctx.lineTo(universe.packet_end_x(), universe.packet_end_y());
          ctx.stroke();
        } else {
          fill_color(0);
          draw_circle(
            universe.packet_x(),
            universe.packet_y(),
            universe.packet_radius()
          );
        }
        fill_color(3);
        // Draw Stars
        for (var i = 0; i < universe.num_stars(); i++) {
          draw_circle(
            universe.star_x(i),
            universe.star_y(i),
            universe.star_radius(i)
          );
        }
        // Draw Planets
        for (var i = 0; i < universe.num_planets(); i++) {
          draw_circle(
            universe.planet_x(i),
            universe.planet_y(i),
            universe.planet_radius(i)
          );
        }
      }

      async function run() {
        await init();
        canvas.addEventListener("click", function () {
          universe.free_packet();
        });
        universe = Universe.new(window.innerWidth, window.innerHeight, 3);
        window.requestAnimationFrame(draw);
      }

      run();
    </script>
  </body>
</html>
